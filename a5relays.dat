STATE ZERO     = 000000470080000000000000000000000000000008000000111111111111111100800000FF000000000000000000000000000000000000000000000012201300000000000300000000006CC300001CC3000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE PLUS25V  = 000000470080000000000000000000000000000008000000111111111111111100800000FE000000000000000000000000000000000000000000000012201300000000000300000000006CC300001CC3000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE PLUS5VA  = 00FCFF460080000000000000000000000000000008000000111111111111111100800000FD000000000000000000000000000000000000000000000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE MINUS25V = 00FCFF460080000000000000000000000000000008000000111111111111111100800000EF000000000000000000000000000000000000000000000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE MINUS5V  = 00FCFF460080000000000000000000000000000008000000111111111111111100800000DF000000000000000000000000000000000000000000000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE PLUSDAC  = 00FCFF460080000000000000000000000000000008000000111111111111111100800000F5000000000000000000000000000000000000000000000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE HV300    = 00BD40470040000000000000000000000000000008000000111111111111111100800000AA00000000000000000000000000000000000000330300001220130000000000030000007874814B822E424B000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE ICHECK   = 0076F9460080000000000000000000000000000008000000111111111111111100800000FF000000AC0D0000AC0D0000FA000000D007000000000000122013008000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000111111111111111100080008000000000000000000000000
STATE IR100    = 0076F946666600000000000000000000000000000CC40084111111111111111100800000F00000000000000000000000C8000000FA00000000000000122013008000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000080008000000000000000000000000
STATE HVOUT    = 00BD40470040000000000000000000000000000008000000111111111111111100800000BB00000000000000000000000000000000000000330300001220130000000000030000007874814B822E424B000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K80GND   = 00FCFF46008000000000000000000000000000000C850C80111111111111111100800000F0000000000000000000000000000000000000000000000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K80UON   = 00FEFF468380000000000000000000000000000088000088111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000000001C30000A2C2000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K80ION   = 00FCFF460080000000000000000000000000000009000084111111111111111100800000F00000000000000000000000FA000000FA0000003303000012201300000000000300000000A09FC400806CC4000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K81TEST  = 0076F946008000000000000000000000000000008CF00048111111111111111100800000F10000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K82TEST  = 0076F946008000000000000000000000000000008CF00028111111111111111100800000F20000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K83TEST  = 0076F946008000000000000000000000000000008CF00018111111111111111100800000F30000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K84TEST  = 0076F9460040000000000000000000000000000008880080111111111111111100800000F00000000000000000000000C8000000FA00000000000000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000080008000000000000000000000000
STATE K84SHORT = 0076F946004000000000000000000000000000000CC80C80111111111111111100800000F00000000000000000000000C8000000FA00000000000000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000080008000000000000000000000000
STATE K85EXTRA = 00AAFA4600C000000000000000000000000000000CF40F80111111111111111100800000F0000000D0070000D0070000FA000000FA0000000000000012201300800000000300000020962AC9B0E3FFC8000000000000000008000000000000000000000000000000000000000000000000080008000000000000000000000000
STATE K86TEST  = 0076F946337300000000000000000000000000000DC00086111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K86IU    = 0076F946337300000000000000000000000000000DC00084111111111111111100800000F40000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K87TEST  = 0076F9463373000000000000000000000000000009A00085111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K87IU    = 0076F9463373000000000000000000000000000009A00084111111111111111100800000F40000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K8889OFF = 00BD40470040000000000000000000000000000008000000111111111111111100800000990000000000000000000000FA000000FA00000033030000122013000C000000030000007874814B822E424B000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K88TST   = 00BD404700400000000000000000000000000000082522001111111111111111008000009F0000000000000000000000FA000000FA00000033030000122013000C000000030000007874814B822E424B000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K89TST   = 00BD40470040000000000000000000000000000008451400111111111111111100800000F90000000000000000000000FA000000FA00000033030000122013000C000000030000007874814B822E424B000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K90TEST  = 0076F9468F82000000000000000000000000000009A02084111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K91TEST  = 0076F946008000000000000000000000000000000DC00084111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K92TEST  = 0076F94666A600000000000000000000000000000A000084111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K94TEST  = 0076F946838000000000000000000000000000000CE82080111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K9599TST = 0076F946CD4C000000000000000000000000000009900184111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K96TEST  = 0076F9466666000000000000000000000000000009350384111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K97TEST  = 0076F9466666000000000000000000000000000009801486111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K98TEST  = 0076F946666600000000000000000000000000000EC02285111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K99AC    = 0076F94666E6180000000000000000000000000088800080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K102TEST = 0076F94666E6170000000000000000000000000088800080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K106TEST = 0076F94666E617000000000000000000000000008CC00080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K107SHO  = 0042E6460040000000000000000000000000000018F00F00111111111111111100800000F50000000000000000000000FA000000FA0000003303000012201300000000000300000010EF4DCA89731ACA000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K107TEST = 0076F9460080000000000000000000000000000018180010111111111111111100800000F30000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K109TEST = 0076F946CD4C00000000000000000000000000001D451494111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE K88HV1K  = 00BD40479A5900300000000000000000000000000DE000041111111111111111008000009F0000000000000000000000FA000000FA000000000000001220130000000000030000007874814B822E424B000000000000000008000000000000120000000000000000000000000000000000080008000000000000000000000000
STATE K89HV1K  = 00BD404766A600300000000000000000000000000DE00004111111111111111100800000F90000000000000000000000FA000000FA000000000000001220130000000000030000007874814B822E424B000000000000000008000000000000120000000000000000000000000000000000080008000000000000000000000000

// UI bus is connected to +MUX and through 1000||100 kOhm - to analog ground.
STATE UIVOLT   = 0076F946838000000000000000000000000000000CC81080111111111111111100800000F0000000000000000000000058020000FA00000033030000122013000000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE UI300MA  = 0076F946838000000000000000000000000000000CC81080111111111111111100800000F0000000000000000000000058020000FA00000000000000122013008000000003000000C0FF48C9A0AD15C9000000000000000008000000000000000000000000000000000000000000000000080008000000000000000000000000

STATE HEADDIR  = 00AAFA4633B3080000000000000000000000000009F00084111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE UITEST   = 00AAFA46666608000000000000000000000000000A000784111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE UICAP    = 00AAFA4600C018000000000000000000000000008A000080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE MINUSTST = 00AAFA46666608000000000000000000000000000E000284111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE MINUSCAP = 00AAFA4600C018000000000000000000000000008AA00080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE PLUSTEST = 00AAFA46666608000000000000000000000000000A900484111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE PLUSCAP  = 00AAFA4600C018000000000000000000000000008AC00080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE GNDTEST  = 00AAFA46666608000000000000000000000000000EC00184111111111111111100800000F00000000000000000000000FA000000FA00000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000
STATE GNDCAP   = 00AAFA4600C018000000000000000000000000008A900080111111111111111100800000F00000000000000000000000E8030000D007000033030000122013000000000003000000B08F2AC917D8FFC8000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000

  INFO    ""
  INFO    "------------------------------------------------------------"
  INFO    ""
  INFO    "This script only checks that relays are functional. It does"
  INFO    "not attempt to verify reswitching time or reliability."
  INFO    "Please note that script detects only single relay errors. If"
  INFO    "two or more relays are damaged, results may be misleading."
  INFO    ""
  CARDTYPE
  DELAY   700
START:
  DRAWNONE
  NOZERO
  SET     ZERO
  DELAY   50
  FIXDEF

  MESSAGE "Testing basic ADC functions..."
  VOLTAGE -0.050 0.050 ERROR "Invalid voltage between +AGND and -AGND on multiplexer"
  FIXZERO
  SET     PLUS25V
  VOLTAGE 2.480 2.520 ERROR "Invalid voltage between +2.5V and -AGND on multiplexer"
  SET     PLUS5VA
  VOLTAGE 4.800 5.200 ERROR "Invalid voltage between +5VA and -AGND on multiplexer"
  SET     MINUS25V
  VOLTAGE -2.520 -2.480 ERROR "Invalid voltage between +AGND and -2.5V on multiplexer"
  SET     MINUS5V
  VOLTAGE -5.040 -4.960 ERROR "Invalid voltage between +AGND and -5V on multiplexer"

  MESSAGE "Testing basic DAC functions..."
  SET     PLUSDAC
  VOLTAGE -0.050 0.050 ERROR "Invalid DAC zero voltage"
  FIXZERO
  SETDAC  -10.0
  VOLTAGE -2.520 -2.480 ERROR "Invalid DAC -2.5 V voltage"
  SETDAC  -5.0
  VOLTAGE -1.260 -1.240 ERROR "Invalid DAC -1.25 V voltage"
  SETDAC  5.0
  VOLTAGE 1.240 1.260 ERROR "Invalid DAC +1.25 V voltage"
  SETDAC  10.0
  VOLTAGE 2.480 2.520 ERROR "Invalid DAC +2.5 V voltage"
  SET     K107SHO
  VOLTAGE -0.100 0.100 ERROR K107NOSH
  SET     ZERO
  STOP    "Voltage on bus or K107 (M_DACGND) is always ON"
K107NOSH:

  MESSAGE "Testing ADC amplifier..."
  SET     PLUSDAC
  SETADC  AMPL=2
  SETDAC  0.0
  FIXZERO
  SETDAC  3.6
  VOLTAGE 1.780 1.820 ERROR "Invalid amplification x2"
  SETADC  AMPL=5
  SETDAC  0.0
  FIXZERO
  SETDAC  3.6
  VOLTAGE 4.450 4.550 ERROR "Invalid amplification x5"
  SETADC  AMPL=10
  SETDAC  0.0
  FIXZERO
  SETDAC  3.6
  VOLTAGE 8.900 9.100 ERROR "Invalid amplification x10"
  DEFZERO

  MESSAGE "Assuring that HV source is OFF..."
  SET     HV300
  VOLTAGE -0.200 0.200 ERROR "HV source seems to be permanently ON"
  SET     HVOUT
  VOLTAGE -0.200 0.200 ERROR "HV source seems to be permanently ON"
  DRAWMEAS

  MESSAGE "Assuring that current sources are OFF..."
  SET     ICHECK
  SETDAC  -2.0
  DELAY   10
  IOVLDP  ERROR ISRCOK
  SETDAC  2.0
  DELAY   10
  IOVLDM  ERROR ISRCOK
  SET     ZERO
  DRAWRLY K105=OPTBAD K110=OPTBAD K111=OPTBAD
  WARNING "K105, K110 or K111 is permanently ON"
  SET     IR100
  VOLTAGE 3.0 10.0 SUCCESS K105SHORT
  SET ZERO
  LIMITS  0.5 3.0 SUCCESS  K110SHORT
  LIMITS  -0.5 0.5 SUCCESS K111SHORT
  STOP
K105SHORT:
  SET ZERO
  DRAWRLY K105=BAD
  STOP    "Probably this is K105 (M_I300MA)"
K110SHORT:
  DRAWRLY K110=BAD
  STOP    "Probably this is K110 (M_HIGH)"
K111SHORT:
  DRAWRLY K111=BAD
  STOP    "Probably this is K111 (M_LOW)"

ISRCOK:
  IF HV1000 GOTO K88HV1000
  MESSAGE "Testing K88 (M_HVMINUS) and K89 (M_HVPLUS)..."
  // Note that this test is not 100% reliable.
  SET     K8889OFF
  DELAY   20
  VOLTAGE -0.500 0.500 ERROR "HV source reports high current without load"
  SET     K88TST
  DELAY   20
  VOLTAGE -0.500 0.500 ERROR "K88 (M_HVMINUS) is always ON"
  RELAY   K88=ON
  DELAY   20
  VOLTAGE -0.500 0.500 SUCCESS "K88 (M_HVMINUS) is always OFF"
  SET     K89TST
  DELAY   20
  VOLTAGE -0.500 0.500 ERROR "K89 (M_HVPLUS) is always ON"
  RELAY   K89=ON
  DELAY   20
  VOLTAGE -0.500 0.500 SUCCESS "K89 (M_HVPLUS) is always OFF"
  DRAWRLY K88=OK, K89=OK
K88HV1000:

  MESSAGE "Testing K80 (M_UIMUX)..."
  // Check that K80 can be turned on, first with U source and, it it fails,
  // with I. If I also fails but voltage is near 0, UIBUS is on ground.
  SET     K80GND
  DELAY   50
  VOLTAGE -0.020 0.020 ERROR "K80 (M_UIMUX) is always OFF"
  SET     K80UON
  SETDAC  -1.0
  VOLTAGE 0.900 1.100 ERROR K80UFAILED
  SETDAC  1.0
  VOLTAGE -1.100 -0.900 SUCCESS K80ISON
K80UFAILED:
  SET     K80ION
  SETDAC  -1.0
  VOLTAGE 9.900 19.999 SUCCESS K80ISON
  SETDAC  1.0
  VOLTAGE -19.999 -9.900 SUCCESS K80ISON
  LIMITS  -0.100 0.100 ERROR "K80 (M_UIMUX) is always OFF"
K80ISON:
  // Check that K80 can be turned off, first in "free fall" and then with U
  // source.
  SET     K80GND
  RELAY   K80=OFF
  DELAY   100
  VOLTAGE -0.150 0.150 ERROR K80ISOFF
  SET     K80UON
  RELAY   K80=OFF
  SETDAC  -1.0
  VOLTAGE 0.900 1.100 ERROR K80ISOFF
  SETDAC  1.0
  VOLTAGE -1.100 -0.900 ERROR K80ISOFF
  LIMITS  -0.100 0.100 ERROR "K80 (M_UIMUX) is always ON"
K80ISOFF:
  DRAWRLY K80=OK

  MESSAGE "Testing K84 (M_U) and K104 (M_U100R)..."
  SET     K84TEST
  SETDAC  -5.0
  UOVLD   SUCCESS "Disconnected voltage source reports high current"
  RELAY   K84=ON K104=ON
  DELAY   30
  UOVLD   SUCCESS UOVERLOAD
  SETDAC  -5.0
  VOLTAGE 4.500 5.500 ERROR "Voltage source is damaged, or both K84 (M_U) and K104 (M_U100R) are always OFF"
  SETDAC  5.0
  VOLTAGE -5.500 4.500 ERROR "Voltage source is damaged, or both K84 (M_U) and K104 (M_U100R) are always OFF"
  SET     K84TEST
  RELAY   K84=ON
  SETDAC  -2.0
  VOLTAGE -0.100 0.100 SUCCESS "K84 (M_U) is always OFF"
  SET     UIVOLT
  RELAY   K84=OFF K101=ON K103=ON
  DELAY   20
  VOLTAGE 1.600 2.400 SUCCESS "K84 (M_U) is always ON"
  VOLTAGE 0.600 2.400 SUCCESS "K104 (M_U100R) is always ON"
  RELAY   K104=ON K101=OFF
  SETDAC  -5.0
  DELAY   20
  VOLTAGE -0.100 0.100 ERROR K104ISON
  // May happen that K93 (M_PLUSGND) is always on, try to disconnect PLUS bus.
  RELAY   K97=OFF K109=OFF
  DELAY   10
  VOLTAGE -0.100 0.100 SUCCESS "K104 (M_U100R) is always OFF"
K104ISON:
  RELAY   K104=OFF K101=ON
  DELAY   20
  VOLTAGE 2.000 3.500 SUCCESS "K104 (M_U100R) is always ON"
  VOLTAGE 3.500 5.500 SUCCESS "K84 (M_U) is always ON"
  DRAWRLY K84=OK, K104=OK
  GOTO K84OK
UOVERLOAD:
  // Voltage source is overloaded, shortcut on bus.
  SET     K84SHORT
  RELAY   K84=ON K104=OFF
  UOVLD   ERROR "K84 (M_U) is always OFF"
  DRAWRLY K84=OK, K104=OK
  RELAY   K84=OFF K104=ON
  UOVLD   SUCCESS K84OK
  WARNING "K104 (M_U100R) is absent (very old card) or always OFF"
  DRAWRLY K104=OPTBAD
  SETFLAG 104
K84OK:

  MESSAGE "Testing K85 (M_I)..."
  SET     UIVOLT
  RELAY   K110=ON K111=OFF K85=ON
  SETDAC  2.0
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR NOK85HIGHI
  SETDAC  -2.0
  DELAY   10
  VOLTAGE 9.500 11.000 SUCCESS K85ONOK
NOK85HIGHI:
  RELAY   K110=OFF K111=ON K85=ON
  SETDAC  9.0
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR NOK85LOWI
  SETDAC  -9.0
  DELAY   10
  VOLTAGE 9.500 11.000 ERROR NOK85LOWI
K85ONOK:
  RELAY   K85=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 ERROR "K85 (M_I) is always ON"
  GOTO K85OK
NOK85LOWI:
  // May happen that U/I is connected to the ground. Let's try alternative way
  // using I saturation bits.
  SET     K85EXTRA
  RELAY   K110=ON
  DELAY   20
  IOVLD   SUCCESS K85SAT
  RELAY   K110=OFF K111=ON
  DELAY   20
  IOVLD   ERROR "Either K85 (M_I) is always ON, or both K110 and K111 are OFF, or current source is damaged"
K85SAT:
  RELAY   K85=ON
  DELAY   20
  IOVLD   SUCCESS "K85 (M_I) is always OFF"
K85OK:
  DRAWRLY K85=OK

  MESSAGE "Testing K105 (M_I300MA)..."
  DRAWRLY K105=OK
  SET     UI300MA
  RELAY   K105=ON K85=ON
  SETDAC  1.0
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR K105LOW
  RELAY   K105=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 SUCCESS K105OK
  RELAY   K101=ON K103=ON
  VOLTAGE -11.000 -1.800 SUCCESS "K105 (M_I300MA) is always ON"
  GOTO K105OK
K105LOW:
  // May happen that U/I is connected to the ground. Let's try alternative way
  // using I saturation bits.
  SET     K85EXTRA
  RELAY   K85=ON
  DELAY   10
  RELAY   K85=OFF
  DELAY   50
  IOVLD   SUCCESS "K105 (M_I300MA) is always ON"
  RELAY   K105=ON
  DELAY   50
  IOVLD   SUCCESS K105OK
  WARNING "K105 (M_I300MA, optional) is always OFF"
  DRAWRLY K105=OPTBAD
K105OK:

  MESSAGE "Testing K110 (M_HIGH) and K111 (M_LOW)..."
  SET     UIVOLT
  RELAY   K110=ON K111=OFF K85=ON
  SETDAC  3.0
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR K110LOW
  RELAY   K110=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 SUCCESS K110OK
  RELAY   K101=ON K103=ON
  VOLTAGE -11.000 -1.800 SUCCESS "K110 (M_HIGH) is always ON"
  LIMITS  -0.800 0.500 SUCCESS "K111 (M_LOW) is always ON"
  GOTO K110OK
K110LOW:
  // May happen that U/I is connected to the ground. Let's try alternative way
  // using I saturation bits.
  SET     K85EXTRA
  RELAY   K85=ON
  DELAY   10
  RELAY   K85=OFF
  DELAY   50
  IOVLD   SUCCESS "Either K110 (M_HIGH) or K111 (M_LOW) is always ON"
  RELAY   K110=ON
  DELAY   50
  IOVLD   ERROR "K110 (M_HIGH) is always OFF"
K110OK:
  SET     UIVOLT
  RELAY   K110=OFF K111=ON K85=ON
  SETDAC  5.0
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR K111LOW
  RELAY   K111=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 ERROR "Either K110 (M_HIGH) or K111 (M_LOW) is always ON"
  GOTO K111OK
K111LOW:
  // May happen that U/I is connected to the ground. Let's try alternative way
  // using I saturation bits.
  SET     K85EXTRA
  RELAY   K85=ON
  DELAY   10
  RELAY   K85=OFF
  DELAY   50
  IOVLD   SUCCESS "Either K110 (M_HIGH) or K111 (M_LOW) is always ON"
  RELAY   K111=ON
  DELAY   50
  IOVLD   ERROR "K111 (M_LOW) is always OFF"
K111OK:
  DRAWRLY K110=OK, K111=OK

  MESSAGE "Testing K92 (M_UIGND)..."
  SET     K92TEST
  RELAY   K92=ON
  DELAY   10
  VOLTAGE -0.200 0.200 ERROR "K92 (M_UIGND) is always OFF"
  RELAY   K92=OFF
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR "K92 (M_UIGND) is always ON"
  DRAWRLY K92=OK

  MESSAGE "Testing K93 (M_PLUSGND)..."
  SET     UIVOLT
  RELAY   K110=ON K85=ON K93=ON
  SETDAC  3.0
  DELAY   10
  VOLTAGE -0.200 0.200 ERROR "K93 (M_PLUSGND) is always OFF"
  FIXZERO
  RELAY   K93=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 SUCCESS "K93 (M_PLUSGND) is always ON"
  DEFZERO
  DRAWRLY K93=OK

  MESSAGE "Testing K98 (M_MINUSSHORT)..."
  SET     K98TEST
  RELAY   K98=ON
  VOLTAGE -0.200 0.200 ERROR "K98 (M_MINUSSHORT) is always OFF"
  RELAY   K98=OFF
  VOLTAGE -0.250 0.250 SUCCESS "K98 (M_MINUSSHORT) is always ON"
  DRAWRLY K98=OK

  MESSAGE "Testing K94 (M_MINUSGND)..."
  SET     K94TEST
  RELAY   K110=ON K85=ON K94=ON
  SETDAC  3.0
  DELAY   10
  VOLTAGE -0.200 0.200 ERROR "K94 (M_MINUSGND) is always OFF"
  FIXZERO
  RELAY   K94=OFF
  DELAY   10
  VOLTAGE -0.200 0.200 SUCCESS "K94 (M_MINUSGND) is always ON"
  DEFZERO
  DRAWRLY K94=OK

  MESSAGE "Testing K96 (M_UISHORT)..."
  SET     K96TEST
  RELAY   K96=ON
  VOLTAGE -0.200 0.200 ERROR "K96 (M_UISHORT) is always OFF"
  RELAY   K96=OFF
  VOLTAGE 9.500 11.000 ERROR "K96 (M_UISHORT) is always ON"
  DRAWRLY K96=OK

  MESSAGE "Testing K109 (M_UIPLUS)..."
  SET     K109TEST
  VOLTAGE -0.200 0.200 ERROR K109OFF
  RELAY   K109=OFF
  VOLTAGE 9.500 11.000 ERROR "K109 (M_UIPLUS) is always ON"
  DRAWRLY K109=OK
  GOTO    K109DONE
K109OFF:
  WARNING "K109 (M_UIPLUS, optional) is always OFF"
  DRAWRLY K109=OPTBAD
K109DONE:

  MESSAGE "Testing K101 (M_R100SHORT)..."
  SET     UIVOLT
  RELAY   K110=ON K85=ON K101=ON
  SETDAC  -2.0
  VOLTAGE 1.600 2.200 ERROR "K101 (M_R100SHORT) is always OFF"
  FIXZERO
  RELAY   K101=OFF
  VOLTAGE -0.100 0.100 SUCCESS "K101 (M_R100SHORT) is always ON"
  DEFZERO
  DRAWRLY K101=OK

  MESSAGE "Testing K103 (M_1KSHORT)..."
  SET     UIVOLT
  RELAY   K110=ON K85=ON K103=ON
  SETDAC  -0.5
  DELAY   10
  VOLTAGE 4.000 6.000 ERROR "K103 (M_1KSHORT) is always OFF"
  RELAY   K103=OFF
  DELAY   10
  VOLTAGE 4.000 6.000 SUCCESS "K103 (M_1KSHORT) is always ON"
  VOLTAGE -9.500 11.000 ERROR "K103 (M_1KSHORT) is unreliable"
  DRAWRLY K103=OK

  Message "Testing K91 (M_100KPLUS)..."
  SET     K91TEST
  SETDAC  0.2
  DELAY   10
  VOLTAGE -7.000 -3.000 SUCCESS "K91 (M_100KPLUS) is always ON"
  LIMITS  -2.0 2.0 ERROR K91NOK89
  SETFLAG 91
K91NOK89:
  RELAY   K91=ON
  DELAY   10
  VOLTAGE -11.000 -9.500 SUCCESS "K91 (M_100KPLUS) is always OFF"
  IF      91 GOTO SKIP100KP
  FIXZERO
  SETDAC  -0.2
  DELAY   10
  VOLTAGE 9.000 11.000 ERROR "Invalid 100 K resistor at K91 (M_100KPLUS)"
SKIP100KP:
  DEFZERO
  DRAWRLY K91=OK

  IFNOT HV1000 GOTO K88HV500
  MESSAGE "Testing K88 (M_HVMINUS) and K89 (M_HVPLUS)..."
  // Note that this test is not 100% reliable.
  SET K88HV1K
  DELAY   10
  VOLTAGE -0.2 0.2 ERROR "K88 (M_HVMINUS) is always ON"
  RELAY K88=ON
  DELAY   10
  VOLTAGE -8.0 -5.0 ERROR "K88 (M_HVMINUS) is always OFF"
  DRAWRLY K88=OK
  SET K89HV1K
  DELAY   10
  VOLTAGE -0.2 0.2 ERROR "K89 (M_HVPLUS) is always ON"
  RELAY K89=ON
  DELAY   10
  VOLTAGE -8.0 -5.0 ERROR "K89 (M_HVPLUS) is always OFF"
  DRAWRLY K89=OK
K88HV500:

  Message "Testing K100 (M_1MSHORT)..."
  SET     UIVOLT
  RELAY   K111=ON K85=ON K100=OFF
  SETDAC  0.2
  DELAY   10
  FIXZERO
  RELAY   K100=ON
  DELAY   10
  VOLTAGE -0.100 0.100 SUCCESS "K100 (M_1MSHORT) does not reswitch"
  LIMITS  0.250 0.650 ERROR "Invalid 1 M resistor at K100 (M_1MSHORT)"
  DEFZERO
  DRAWRLY K100=OK

  MESSAGE "Testing K97 (M_PLUSSHORT)..."
  SET     K97TEST
  RELAY   K97=ON
  VOLTAGE -0.200 0.200 ERROR "K97 (M_PLUSSHORT) is always OFF"
  RELAY   K97=OFF
  VOLTAGE 9.500 11.000 ERROR "K97 (M_PLUSSHORT) is always ON"
  DRAWRLY K97=OK

  MESSAGE "Testing K95 (M_GNDGND) and K99 (M_GNDSHORT)..."
  SET     K9599TST
  VOLTAGE -0.200 0.200 ERROR K99AC
  RELAY   K95=OFF
  VOLTAGE 9.500 11.000 ERROR "K95 (M_GNDGND) is always ON"
  RELAY   K95=ON K99=OFF
  VOLTAGE 9.500 11.000 ERROR "K99 (M_GNDSHORT) is always ON"
  GOTO    K99DONE
K99AC:
  IF      104 GOTO K9599OFF
  SET     K99AC
  FIXPHASE
  RELAY   K99=ON
  PHASE   -0.100 0.100 SUCCESS "K99 (M_GNDSHORT) is always OFF"
  STOP    "K95 (M_GNDGND) is always OFF"
K9599OFF:
  STOP    "K95 (M_GNDGND) or K99 (M_GNDSHORT) is always OFF"
K99DONE:
  DRAWRLY K95=OK, K99=OK

  MESSAGE "Testing K86 (M_IUPLUS)..."
  SET     K86TEST
  VOLTAGE -0.200 0.200 ERROR "K86 (M_IUPLUS) is always OFF"
  RELAY   K86=OFF
  VOLTAGE 9.500 10.500 ERROR "K86 (M_IUPLUS) is always ON"
  SET     K86IU
  VOLTAGE -0.200 0.200 ERROR "I-U converter on PLUS is malfunctional"
  RELAY   K86=ON
  VOLTAGE -11.000 -9.500 ERROR "I-U converter on PLUS is malfunctional"
  DRAWRLY K86=OK

  MESSAGE "Testing K87 (M_IUMINUS)..."
  SET     K87TEST
  VOLTAGE -0.200 0.200 ERROR "K87 (M_IUMINUS) is always OFF"
  RELAY   K87=OFF
  VOLTAGE 9.500 10.500 ERROR "K87 (M_IUMINUS) is always ON"
  SET     K87IU
  VOLTAGE -0.200 0.200 ERROR "I-U converter on MINUS is malfunctional"
  RELAY   K87=ON
  VOLTAGE -11.000 -9.500 ERROR "I-U converter on MINUS is malfunctional"
  DRAWRLY K87=OK

  MESSAGE "Testing K81 (M_PLUSMUX)..."
  SET     K81TEST
  SETDAC  -5.0
  VOLTAGE 4.500 5.500 ERROR "K81 (M_PLUSMUX) is always OFF"
  SETDAC  5.0
  VOLTAGE -5.500 -4.500 ERROR "K81 (M_PLUSMUX) is always OFF"
  RELAY   K81=OFF
  FIXZERO
  SETDAC  -5.0
  VOLTAGE 9.500 10.500 SUCCESS "K81 (M_PLUSMUX) is always ON"
  DEFZERO
  DRAWRLY K81=OK

  MESSAGE "Testing K82 (M_MINUSMUX)..."
  SET     K82TEST
  SETDAC  -5.0
  VOLTAGE 4.500 5.500 ERROR "K82 (M_MINUSMUX) is always OFF"
  SETDAC  5.0
  VOLTAGE -5.500 -4.500 ERROR "K82 (M_MINUSMUX) is always OFF"
  RELAY   K82=OFF
  FIXZERO
  SETDAC  -5.0
  VOLTAGE 9.500 10.500 SUCCESS "K82 (M_MINUSMUX) is always ON"
  DEFZERO
  DRAWRLY K82=OK

  MESSAGE "Testing K83 (M_GNDMUX)..."
  SET     K83TEST
  SETDAC  -5.0
  VOLTAGE 4.500 5.500 ERROR "K83 (M_GNDMUX) is always OFF"
  SETDAC  5.0
  VOLTAGE -5.500 -4.500 ERROR "K83 (M_GNDMUX) is always OFF"
  RELAY   K83=OFF
  FIXZERO
  SETDAC  -5.0
  VOLTAGE 9.500 10.500 SUCCESS "K83 (M_GNDMUX) is always ON"
  DEFZERO
  DRAWRLY K83=OK

  MESSAGE "Testing K90 (M_100KMINUS)..."
  SET     K90TEST
  SETDAC  0.2
  DELAY   10
  VOLTAGE -11.000 -9.500 SUCCESS "K90 (M_100KMINUS) is always OFF"
  SETDAC  -0.2
  DELAY   10
  VOLTAGE 9.500 11.000 SUCCESS "K90 (M_100KMINUS) is always OFF"
  SETDAC  0.2
  DELAY   10
  FIXZERO
  SETDAC  -0.2
  DELAY   10
  VOLTAGE 9.000 11.000 ERROR "K90 (M_100KMINUS) is OFF, or resistance 100 K on MINUS is wrong"
  DEFZERO
  SET     K90TEST
  SETDAC  0.2
  RELAY   K90=OFF
  DELAY   10
  VOLTAGE -11.000 -9.500 ERROR "K90 (M_100KMINUS) is always ON"
  SETDAC  -0.2
  DELAY   10
  VOLTAGE 9.500 11.000 ERROR "K90 (M_100KMINUS) is always ON"
  DRAWRLY K90=OK

  MESSAGE "Testing K107 (M_DACGND)..."
  SET     K107TEST
  SETDAC  -5.0
  DELAY   10
  VOLTAGE -1.500 -1.000 ERROR K107OFF
  SETDAC  5.0
  DELAY   10
  VOLTAGE 1.000 1.500 ERROR K107OFF
  RELAY   K107=OFF
  DELAY   10
  VOLTAGE 1.000 1.500 SUCCESS "K107 (M_DACGND) is always ON"
  SETDAC  -5.0
  DELAY   10
  VOLTAGE -1.500 -1.000 SUCCESS "K107 (M_DACGND) is always ON"
  DRAWRLY K107=OK
  GOTO    K107DONE
K107OFF:
  WARNING "K107 (M_DACGND, optional) is always OFF"
  DRAWRLY K107=OPTBAD
K107DONE:

  IF      104 GOTO K102SKIP
  MESSAGE "Testing K102 (M_C10NSHORT)..."
  SET     K102TEST
  FIXPHASE
  RELAY   K102=ON
  PHASE   -1.000 1.000 SUCCESS "K102 (M_C10NSHORT) does not reswitch"
  PHASE   8.000 14.000 ERROR "Invalid capacity of 10 nF capacitor"
  RELAY   K102=OFF
  PHASE   -0.5000 0.500 ERROR "K102 (M_C10NSHORT) is always ON"
  DRAWRLY K102=OK
  GOTO    K102DONE
K102SKIP:
  WARNING "K102 (M_C10NSHORT) is not tested due to missing K104"
  DRAWRLY K102=OPTBAD
K102DONE:

  IF      104 GOTO K106SKIP
  MESSAGE "Testing K106 (M_C1NPLUS)..."
  SET     K106TEST
  FIXPHASE
  RELAY   K106=ON
  PHASE   -0.300 0.300 SUCCESS "K106 (M_C1NPLUS) does not reswitch"
  PHASE   0.800 1.300 ERROR "Invalid capacity of 1 nF capacitor"
  DRAWRLY K106=OK
  GOTO    K106DONE
K106SKIP:
  WARNING "K106 (M_C1NPLUS) is not tested due to missing K104"
  DRAWRLY K106=OPTBAD
K106DONE:

  DELAY   500
  DRAWMUX

  FIRSTHEAD
HEADDIR:
  IFEXTANT SKIPEXTD
  MESSAGE "Testing direct connection mode of head #H..."
  SET     HEADDIR HEAD=DIR,UI,MINUS,PLUS,GND
  DELAY   30
  VOLTAGE -11.000 -9.500 ERROR "Head #H: shortcut or always in amplifier mode"
  SET     HEADDIR HEAD=I,UI,MINUS,PLUS,GND
  DELAY   50
  VOLTAGE -1.000 1.000 ERROR "Head #H: absent on-head board or always direct connection"
  NEXTHEAD HEADDIR

SKIPEXTD:
  FIRSTHEAD
HEADRLY:

  IFEXTANT ANTNAME
  MESSAGE "Testing multiplexer relays of head #H..."
  GOTO ENDANTNAME
ANTNAME:
  MESSAGE "Testing multiplexer relays of #H..."
ENDANTNAME:

  CLRFLAG 0
  CLRFLAG 1
  DEFZERO
  DRAWRLY HEAD.UI=OK
  SET     UITEST HEAD=DIR,MINUS,PLUS,GND
  VOLTAGE -0.500 0.500 ERROR UIOPEN
  WARNING "#U (OH_UI at #H) is always ON"
  DRAWRLY HEAD.UI=BAD
  SETFLAG 0
  GOTO    UIDONE
UIOPEN:
  SET     UITEST HEAD=UI,DIR,MINUS,PLUS,GND
  VOLTAGE -0.100 0.100 SUCCESS UIDONE
  SET     UICAP
  FIXPHASE
  SET     UICAP HEAD=DIR,UI
  PHASE   -0.010 0.010 ERROR UIDONE
  WARNING "#U (OH_UI at #H) is always OFF"
  DRAWRLY HEAD.UI=BAD
  SETFLAG 1
UIDONE:

  DRAWRLY HEAD.MINUS=OK
  IF      1 GOTO MINUSAC
  SET     MINUSTST HEAD=UI,PLUS
  VOLTAGE -0.500 0.500 ERROR MINUSOPEN
  WARNING "#M (OH_MINUS at #H) is always ON"
  DRAWRLY HEAD.MINUS=BAD
  GOTO    MINUSDONE
MINUSOPEN:
  IFEXTANT MINUSAC
  SET     MINUSTST HEAD=UI,MINUS,PLUS
  VOLTAGE -0.100 0.100 SUCCESS MINUSDONE
  WARNING "#M (OH_MINUS at #H) is always OFF"
  DRAWRLY HEAD.MINUS=BAD
  GOTO    MINUSDONE
MINUSAC:
  SET     MINUSCAP
  FIXPHASE
  SET     MINUSCAP HEAD=DIR,MINUS
  PHASE   -0.010 0.010 ERROR MINUSDONE
  WARNING "#M (OH_MINUS at #H) does not reswitch"
  DRAWRLY HEAD.MINUS=BAD
MINUSDONE:

  DRAWRLY HEAD.PLUS=OK
  IF      1 GOTO PLUSAC
  SET     PLUSTEST HEAD=UI,GND
  VOLTAGE -0.500 0.500 ERROR PLUSOPEN
  WARNING "#P (OH_PLUS at #H) is always ON"
  DRAWRLY HEAD.PLUS=BAD
  GOTO    PLUSDONE
PLUSOPEN:
  IFEXTANT PLUSAC
  SET     PLUSTEST HEAD=UI,PLUS,GND
  VOLTAGE -0.100 0.100 SUCCESS PLUSDONE
  WARNING "#P (OH_PLUS at #H) is always OFF"
  DRAWRLY HEAD.PLUS=BAD
  GOTO    PLUSDONE
PLUSAC:
  SET     PLUSCAP
  FIXPHASE
  SET     PLUSCAP HEAD=DIR,PLUS
  PHASE   -0.010 0.010 ERROR PLUSDONE
  WARNING "#P (OH_PLUS at #H) does not reswitch"
  DRAWRLY HEAD.PLUS=BAD
PLUSDONE:

  DRAWRLY HEAD.GND=OK
  IF      1 GOTO GNDAC
  SET     GNDTEST HEAD=UI,PLUS
  VOLTAGE -0.500 0.500 ERROR GNDOPEN
  WARNING "#G (OH_GND at #H) is always ON"
  DRAWRLY HEAD.GND=BAD
  GOTO    GNDDONE
GNDOPEN:
  IFEXTANT GNDAC
  SET     GNDTEST HEAD=UI,PLUS,GND
  VOLTAGE -0.100 0.100 SUCCESS GNDDONE
  WARNING "#G (OH_GND at #H) is always OFF"
  DRAWRLY HEAD.GND=BAD
  GOTO    GNDDONE
GNDAC:
  SET     GNDCAP
  FIXPHASE
  SET     GNDCAP HEAD=DIR,GND
  PHASE   -0.010 0.010 ERROR GNDDONE
  WARNING "#G (OH_GND at #H) does not reswitch"
  DRAWRLY HEAD.GND=BAD
GNDDONE:

  NEXTHEAD HEADRLY

  DELAY   300

  REPEAT  START

  SET     ZERO
  MESSAGE " "
  MESSAGE "Test finished. Press Continue to toggle display."
  PAUSE
FINLOOP:
  DRAWMEAS
  PAUSE
  DRAWMUX
  PAUSE
  GOTO    FINLOOP
  STOP

